import math

# Pełna baza miast powiatowych PL: województwo -> miasto -> (lat, lon)
POWIATOWE = {
    "dolnośląskie": {
        "Bolesławiec": (51.2643, 15.5657),
        "Dzierżoniów": (50.7286, 16.6512),
        "Głogów": (51.6636, 16.0842),
        "Góra": (51.6664, 16.5402),
        "Jawor": (51.0514, 16.1931),
        "Jelenia Góra": (50.9044, 15.7387),
        "Kamienna Góra": (50.7833, 16.0333),
        "Kłodzko": (50.4341, 16.6616),
        "Legnica": (51.2101, 16.1619),
        "Lubań": (51.1206, 15.2877),
        "Lubin": (51.4011, 16.2023),
        "Lwówek Śląski": (51.1108, 15.5889),
        "Milicz": (51.5278, 17.2712),
        "Oława": (50.9465, 17.2924),
        "Oleśnica": (51.2092, 17.3792),
        "Polkowice": (51.5049, 16.0729),
        "Strzelin": (50.7821, 17.0653),
        "Środa Śląska": (51.1646, 16.5937),
        "Świdnica": (50.8432, 16.4886),
        "Trzebnica": (51.3103, 17.0632),
        "Wałbrzych": (50.7714, 16.2843),
        "Wołów": (51.3349, 16.6418),
        "Wrocław": (51.1079, 17.0385),
        "Ząbkowice Śląskie": (50.5891, 16.8162),
        "Zgorzelec": (51.1494, 15.0084),
        "Złotoryja": (51.1261, 15.9182),
    },
    "kujawsko-pomorskie": {
        "Aleksandrów Kujawski": (52.8792, 18.7009),
        "Brodnica": (53.2592, 19.3933),
        "Bydgoszcz": (53.1235, 18.0084),
        "Chełmno": (53.3498, 18.4242),
        "Golub-Dobrzyń": (53.1101, 19.0475),
        "Grudziądz": (53.4845, 18.7531),
        "Inowrocław": (52.7986, 18.2636),
        "Lipno": (52.8427, 19.1787),
        "Mogilno": (52.6592, 17.9555),
        "Nakło nad Notecią": (53.1425, 17.6015),
        "Radziejów": (52.6271, 18.5264),
        "Rypin": (53.0664, 19.4132),
        "Sępólno Krajeńskie": (53.4527, 17.5327),
        "Świecie": (53.4091, 18.4479),
        "Toruń": (53.0138, 18.5984),
        "Tuchola": (53.5879, 17.8572),
        "Wąbrzeźno": (53.2805, 18.9493),
        "Włocławek": (52.6482, 19.0678),
        "Żnin": (52.8491, 17.7221),
    },
    "lubelskie": {
        "Biała Podlaska": (52.0323, 23.1161),
        "Biłgoraj": (50.5435, 22.7204),
        "Chełm": (51.1431, 23.4717),
        "Hrubieszów": (50.8052, 23.8929),
        "Janów Lubelski": (50.7075, 22.4116),
        "Krasnystaw": (50.9846, 23.1738),
        "Kraśnik": (50.9239, 22.2312),
        "Lubartów": (51.4606, 22.6098),
        "Lublin": (51.2465, 22.5684),
        "Łęczna": (51.2957, 22.8752),
        "Łuków": (51.9291, 22.3797),
        "Opole Lubelskie": (51.1481, 21.9696),
        "Parczew": (51.6331, 22.9001),
        "Puławy": (51.4156, 21.9697),
        "Radzyń Podlaski": (51.7832, 22.6245),
        "Ryki": (51.6247, 21.9338),
        "Świdnik": (51.2187, 22.6941),
        "Tomaszów Lubelski": (50.4475, 23.4163),
        "Włodawa": (51.5496, 23.5472),
        "Zamość": (50.7174, 23.2514),
    },
    "lubuskie": {
        "Gorzów Wielkopolski": (52.7368, 15.2288),
        "Krosno Odrzańskie": (52.0561, 15.0984),
        "Międzyrzecz": (52.4447, 15.5786),
        "Nowa Sól": (51.8049, 15.7181),
        "Słubice": (52.3500, 14.5667),
        "Strzelce Krajeńskie": (52.8776, 15.5297),
        "Sulęcin": (52.4446, 15.1175),
        "Świebodzin": (52.2477, 15.5331),
        "Zielona Góra": (51.9356, 15.5062),
        "Żagań": (51.6174, 15.3178),
        "Żary": (51.6411, 15.1378),
        "Wschowa": (51.8011, 16.3168),
    },
    "łódzkie": {
        "Bełchatów": (51.3682, 19.3561),
        "Brzeziny": (51.7996, 19.7515),
        "Kutno": (52.2316, 19.3648),
        "Łask": (51.5907, 19.1335),
        "Łęczyca": (52.0597, 19.1997),
        "Łowicz": (52.1077, 19.9386),
        "Łódź": (51.7592, 19.45598),
        "Opoczno": (51.3752, 20.2789),
        "Pabianice": (51.6646, 19.3545),
        "Pajęczno": (51.1453, 18.9946),
        "Piotrków Trybunalski": (51.4052, 19.7032),
        "Poddębice": (51.8893, 18.9565),
        "Radomsko": (51.0687, 19.4442),
        "Rawa Mazowiecka": (51.7635, 20.2544),
        "Sieradz": (51.5950, 18.7301),
        "Skierniewice": (51.9650, 20.1584),
        "Tomaszów Mazowiecki": (51.5311, 20.0086),
        "Wieluń": (51.2211, 18.5699),
        "Wieruszów": (51.3002, 18.1531),
        "Zduńska Wola": (51.6038, 18.9396),
        "Zgierz": (51.8557, 19.4068),
    },
    "małopolskie": {
        "Bochnia": (49.9697, 20.4301),
        "Brzesko": (49.9687, 20.6064),
        "Chrzanów": (50.1336, 19.4038),
        "Dąbrowa Tarnowska": (50.1776, 20.9848),
        "Gorlice": (49.6568, 21.1607),
        "Kraków": (50.06143, 19.93658),
        "Limanowa": (49.7069, 20.4216),
        "Miechów": (50.3575, 20.0257),
        "Myślenice": (49.8338, 19.9382),
        "Nowy Sącz": (49.62177, 20.69705),
        "Nowy Targ": (49.4772, 20.0325),
        "Olkusz": (50.28054, 19.56349),
        "Oświęcim": (50.0344, 19.2102),
        "Proszowice": (50.1982, 20.2902),
        "Sucha Beskidzka": (49.7401, 19.5996),
        "Tarnów": (50.01381, 20.98698),
        "Wadowice": (49.8821, 19.4933),
        "Wieliczka": (49.9872, 20.0646),
        "Zakopane": (49.29919, 19.94956),
    },
    "mazowieckie": {
        "Ciechanów": (52.8812, 20.6197),
        "Garwolin": (51.8976, 21.6144),
        "Gostynin": (52.4297, 19.4611),
        "Grójec": (51.8642, 20.8679),
        "Kozienice": (51.5827, 21.5471),
        "Legionowo": (52.4029, 20.9265),
        "Maków Mazowiecki": (52.8647, 21.1017),
        "Mińsk Mazowiecki": (52.1796, 21.5695),
        "Mława": (53.1122, 20.3804),
        "Nowy Dwór Mazowiecki": (52.4303, 20.7161),
        "Ostrołęka": (53.0847, 21.5756),
        "Ostrów Mazowiecka": (52.8078, 21.8933),
        "Otwock": (52.1052, 21.2612),
        "Płock": (52.5468, 19.7064),
        "Płońsk": (52.6232, 20.3759),
        "Pruszków": (52.1708, 20.8062),
        "Przasnysz": (53.0192, 20.8799),
        "Radom": (51.4027, 21.1471),
        "Siedlce": (52.1677, 22.2906),
        "Sierpc": (52.8531, 19.6695),
        "Sochaczew": (52.2296, 20.2385),
        "Sokołów Podlaski": (52.4069, 22.2539),
        "Warszawa": (52.2297, 21.0122),
        "Węgrów": (52.3982, 22.0177),
        "Wołomin": (52.3406, 21.2426),
        "Wyszków": (52.5922, 21.4577),
        "Zwoleń": (51.3424, 21.5844),
        "Żuromin": (53.0672, 19.8979),
        "Żyrardów": (52.0501, 20.4455),
    },
    "opolskie": {
        "Brzeg": (50.8603, 17.4675),
        "Głubczyce": (50.2011, 17.8287),
        "Kędzierzyn-Koźle": (50.3494, 18.2262),
        "Kluczbork": (50.9726, 18.2183),
        "Krapkowice": (50.4721, 17.9632),
        "Namysłów": (51.0775, 17.7227),
        "Nysa": (50.4734, 17.3341),
        "Opole": (50.6751, 17.9213),
        "Olesno": (50.8763, 18.4222),
        "Prudnik": (50.3224, 17.5811),
        "Strzelce Opolskie": (50.5135, 18.3049),
    },
    "podkarpackie": {
        "Brzozów": (49.6912, 22.0199),
        "Dębica": (50.0529, 21.4116),
        "Jarosław": (50.0162, 22.6771),
        "Jasło": (49.7486, 21.4724),
        "Krosno": (49.6937, 21.7708),
        "Leżajsk": (50.2638, 22.4261),
        "Lubaczów": (50.1586, 23.1225),
        "Łańcut": (50.0683, 22.2308),
        "Mielec": (50.2876, 21.4234),
        "Nisko": (50.5233, 22.1407),
        "Przemyśl": (49.7842, 22.7676),
        "Przeworsk": (50.0595, 22.4956),
        "Ropczyce": (50.0529, 21.6129),
        "Rzeszów": (50.0412, 21.9991),
        "Sanok": (49.5633, 22.2056),
        "Stalowa Wola": (50.5741, 22.0534),
        "Strzyżów": (49.8727, 21.7918),
        "Tarnobrzeg": (50.5736, 21.6797),
        "Ustrzyki Dolne": (49.4307, 22.5973),
    },
    "podlaskie": {
        "Augustów": (53.8437, 22.9794),
        "Białystok": (53.1325, 23.1688),
        "Bielsk Podlaski": (52.7653, 23.1914),
        "Grajewo": (53.6473, 22.4557),
        "Hajnówka": (52.7437, 23.5841),
        "Kolno": (53.4049, 21.9308),
        "Łomża": (53.1781, 22.0597),
        "Mońki": (53.4078, 22.7985),
        "Sejny": (54.1117, 23.3494),
        "Siemiatycze": (52.4277, 22.8611),
        "Sokółka": (53.4083, 23.5041),
        "Suwałki": (54.1111, 22.9303),
        "Wysokie Mazowieckie": (52.9162, 22.5131),
        "Zambrów": (52.9853, 22.2408),
    },
    "pomorskie": {
        "Bytów": (54.1707, 17.4912),
        "Chojnice": (53.6981, 17.5566),
        "Człuchów": (53.6648, 17.3583),
        "Gdańsk": (54.3520, 18.6466),
        "Gdynia": (54.5189, 18.5305),
        "Kartuzy": (54.3345, 18.1989),
        "Kościerzyna": (54.1221, 17.9729),
        "Kwidzyn": (53.7265, 18.9313),
        "Lębork": (54.5394, 17.7518),
        "Malbork": (54.0366, 19.0262),
        "Nowy Dwór Gdański": (54.2157, 19.1198),
        "Pruszcz Gdański": (54.2627, 18.6362),
        "Puck": (54.7201, 18.4109),
        "Słupsk": (54.4641, 17.0287),
        "Starogard Gdański": (53.9631, 18.5266),
        "Sztum": (53.9207, 19.0292),
        "Tczew": (54.0924, 18.7778),
        "Wejherowo": (54.6054, 18.2356),
    },
    "śląskie": {
        "Będzin": (50.3262, 19.1275),
        "Bielsko-Biała": (49.82238, 19.04685),
        "Bytom": (50.3480, 18.9328),
        "Chorzów": (50.3058, 18.9742),
        "Cieszyn": (49.7513, 18.6354),
        "Częstochowa": (50.81182, 19.12031),
        "Dąbrowa Górnicza": (50.3189, 19.2496),
        "Gliwice": (50.29449, 18.67138),
        "Jastrzębie-Zdrój": (49.9513, 18.5897),
        "Jaworzno": (50.2054, 19.2750),
        "Katowice": (50.2599, 19.0216),
        "Lubliniec": (50.6692, 18.6847),
        "Mikołów": (50.1763, 18.9003),
        "Mysłowice": (50.2072, 19.1666),
        "Piekary Śląskie": (50.3485, 18.9541),
        "Pszczyna": (49.9808, 18.9441),
        "Racibórz": (50.0913, 18.2198),
        "Ruda Śląska": (50.2596, 18.8563),
        "Rybnik": (50.0971, 18.5417),
        "Siemianowice Śląskie": (50.3158, 19.0294),
        "Sosnowiec": (50.2863, 19.1041),
        "Świętochłowice": (50.2978, 18.9389),
        "Tarnowskie Góry": (50.4456, 18.8603),
        "Tychy": (50.1359, 18.9914),
        "Zabrze": (50.32492, 18.78572),
        "Zawiercie": (50.4871, 19.4293),
        "Żory": (50.0483, 18.7016),
        "Żywiec": (49.6852, 19.2012),
    },
    "świętokrzyskie": {
        "Busko-Zdrój": (50.4709, 20.7202),
        "Jędrzejów": (50.6403, 20.3042),
        "Kazimierza Wielka": (50.2635, 20.4891),
        "Kielce": (50.8661, 20.6286),
        "Końskie": (51.1893, 20.4069),
        "Opatów": (50.8017, 21.4235),
        "Ostrowiec Świętokrzyski": (50.9377, 21.3855),
        "Pińczów": (50.5203, 20.5276),
        "Sandomierz": (50.6825, 21.7496),
        "Skarżysko-Kamienna": (51.1144, 20.8716),
        "Starachowice": (51.0371, 21.0797),
        "Staszów": (50.5637, 21.1655),
        "Sandomierz": (50.6825, 21.7496),
        "Włoszczowa": (50.8527, 19.9663),
    },
    "warmińsko-mazurskie": {
        "Bartoszyce": (54.2531, 20.8083),
        "Braniewo": (54.3795, 19.8197),
        "Działdowo": (53.2313, 20.1779),
        "Elbląg": (54.1522, 19.4045),
        "Ełk": (53.8282, 22.3647),
        "Giżycko": (54.0389, 21.7643),
        "Gołdap": (54.3075, 22.3045),
        "Iława": (53.5953, 19.5638),
        "Kętrzyn": (54.0769, 21.3757),
        "Lidzbark Warmiński": (54.1263, 20.5782),
        "Mrągowo": (53.8645, 21.3047),
        "Nidzica": (53.3602, 20.4275),
        "Nowe Miasto Lubawskie": (53.4219, 19.5971),
        "Olsztyn": (53.7784, 20.4801),
        "Ostróda": (53.6964, 19.9643),
        "Pisz": (53.6276, 21.8121),
        "Szczytno": (53.5622, 20.9892),
        "Węgorzewo": (54.2157, 21.7421),
    },
    "wielkopolskie": {
        "Chodzież": (52.9932, 16.9117),
        "Czarnków": (52.9046, 16.5618),
        "Gniezno": (52.5342, 17.5828),
        "Gostyń": (51.8822, 17.0129),
        "Grodzisk Wielkopolski": (52.2273, 16.3652),
        "Jarocin": (51.9726, 17.5019),
        "Kalisz": (51.7611, 18.0910),
        "Kępno": (51.2787, 17.9896),
        "Koło": (52.2000, 18.6383),
        "Konin": (52.2230, 18.2512),
        "Kościan": (52.0884, 16.6485),
        "Krotoszyn": (51.6977, 17.4372),
        "Leszno": (51.8437, 16.5741),
        "Międzychód": (52.5982, 15.8973),
        "Nowy Tomyśl": (52.3192, 16.1288),
        "Oborniki": (52.6496, 16.8146),
        "Ostrów Wielkopolski": (51.6517, 17.8087),
        "Ostrzeszów": (51.4261, 17.9332),
        "Piła": (53.1511, 16.7388),
        "Pleszew": (51.8962, 17.7818),
        "Poznań": (52.4064, 16.9252),
        "Rawicz": (51.6100, 16.8574),
        "Słupca": (52.2878, 17.8723),
        "Śrem": (52.0882, 17.0155),
        "Środa Wielkopolska": (52.2283, 17.2755),
        "Szamotuły": (52.6130, 16.5797),
        "Turek": (52.0167, 18.5000),
        "Wągrowiec": (52.8052, 17.1993),
        "Wolsztyn": (52.1158, 16.1169),
        "Września": (52.3253, 17.5666),
        "Złotów": (53.3636, 17.0405),
    },
    "zachodniopomorskie": {
        "Białogard": (54.0045, 16.0109),
        "Choszczno": (53.1706, 15.4208),
        "Drawsko Pomorskie": (53.5310, 15.8095),
        "Goleniów": (53.5637, 14.8283),
        "Gryfice": (53.9168, 15.2006),
        "Gryfino": (53.2535, 14.4922),
        "Kamień Pomorski": (53.9697, 14.7727),
        "Kołobrzeg": (54.1764, 15.5760),
        "Koszalin": (54.1944, 16.1722),
        "Łobez": (53.6385, 15.6205),
        "Myślibórz": (52.9275, 14.8657),
        "Police": (53.5472, 14.5711),
        "Pyrzyce": (53.1463, 14.8915),
        "Sławno": (54.3572, 16.6770),
        "Stargard": (53.3369, 15.0490),
        "Szczecin": (53.4285, 14.5528),
        "Szczecinek": (53.7075, 16.6993),
        "Świdwin": (53.7838, 15.7763),
        "Świnoujście": (53.9106, 14.2477),
        "Wałcz": (53.2727, 16.4717),
        "Złocieniec": (53.5323, 16.0038),
    }
}

# Zmapuj miejscowości na powiatówki
def get_powiat_city_for(miasto, woj):
    miasto = miasto.strip().title()
    # Jeśli miasto już jest powiatowe
    if miasto in POWIATOWE.get(woj.lower(), {}):
        return miasto
    # Najprościej: dopasowanie po województwie (lub rozbuduj słownik z aliasami)
    for powiat in POWIATOWE.get(woj.lower(), {}):
        if powiat.lower() == miasto.lower():
            return powiat
    # Jeśli nie znalazło, możesz próbować po całości
    for wojew in POWIATOWE.values():
        if miasto in wojew:
            return miasto
    return None

def _get_coords(miejscowosc):
    miejscowosc = miejscowosc.strip().title()
    for woj in POWIATOWE.values():
        for city, coords in woj.items():
            if city.lower() == miejscowosc.lower():
                return coords
    return None

def calculate_distance_km(miejscowosc1, miejscowosc2):
    coords1 = _get_coords(miejscowosc1)
    coords2 = _get_coords(miejscowosc2)
    if not coords1 or not coords2:
        return -1
    # Haversine formula
    lat1, lon1 = coords1
    lat2, lon2 = coords2
    R = 6371
    phi1, phi2 = math.radians(lat1), math.radians(lat2)
    dphi = math.radians(lat2-lat1)
    dlambda = math.radians(lon2-lon1)
    a = math.sin(dphi/2)**2 + math.cos(phi1)*math.cos(phi2)*math.sin(dlambda/2)**2
    c = 2*math.atan2(math.sqrt(a), math.sqrt(1-a))
    return round(R * c, 1)

